# /TASK_0038 创建缺陷任务时的关联前置任务的交互优化（Design）

## 1. 目标与范围

### 目标（vibe 阶段确认）
- 在“创建缺陷任务 → 选择关联前置任务”阶段：
  - 将 **“跳过 / 取消创建任务”** 从任务列表消息的底部（InlineKeyboard 最后一行）移到 **Telegram 底部菜单栏（ReplyKeyboard）**，与后续“输入描述”等步骤交互一致。
  - 将取消文案从“取消”调整为 **“取消创建任务”**，避免被理解为“取消关联任务”。
- 行为确认：
  - 点击“取消创建任务”应立即退出创建流程并返回主菜单。
  - 不再在列表消息下方保留“跳过/取消”Inline 按钮（仅菜单栏保留）。

### 非目标
- 不改动关联任务列表的数据来源/排序逻辑（仍按“更新时间倒序”分页）。
- 不改动“手动输入 TASK_0001 选择关联任务”的能力。

## 2. 现状定位（技术视角）

### 入口与调用链
- 创建任务流程：`bot.py` `on_task_create_type()` 在选择“缺陷”类型后进入关联任务选择阶段。
- 关联任务选择视图构建：
  - 文本 + InlineKeyboard：`bot.py` `_build_related_task_select_view(page=...)`
- 交互处理：
  - 翻页：`bot.py` `on_task_create_related_page()`
  - 选择任务：`bot.py` `on_task_create_related_select()`
  - 跳过：`bot.py` `on_task_create_related_skip()`（当前由 Inline 按钮触发）
  - 取消：`bot.py` `on_task_create_related_cancel()`（当前由 Inline 按钮触发）
  - 文本输入：`bot.py` `on_task_create_related_task_text()`（支持输入 TASK_0001 / 跳过 / 取消）

### 现状痛点（根因）
- `_build_related_task_select_view()` 当前把“跳过/取消”做成 InlineKeyboard 的最后一行，用户需要滚动到列表底部才能操作。
- “取消”文案在该阶段语义不清，容易被误解为“取消关联任务”。

### 可验证资料（为何需要“单独发一条消息设置 ReplyKeyboard”）
Telegram 每条消息只有一个 `reply_markup` 字段，且其类型是多选一（InlineKeyboardMarkup 或 ReplyKeyboardMarkup 等），因此同一条消息无法同时承载“任务列表 Inline 按钮”和“菜单栏 Reply 按钮”。
- `sendMessage` 的 `reply_markup` 说明：https://core.telegram.org/bots/api#sendmessage
- ReplyKeyboardMarkup：https://core.telegram.org/bots/api#replykeyboardmarkup
- InlineKeyboardMarkup：https://core.telegram.org/bots/api#inlinekeyboardmarkup

## 3. 方案对比（至少 3 种）

### 方案 A（最小改造）
- 仅将 Inline 的“取消”改名为“取消创建任务”，位置不变（仍在列表底部）。
- 优点：改动最小。
- 缺点：不满足“放到菜单栏”的核心诉求。

### 方案 B（推荐 ✅）
- 移除 `_build_related_task_select_view()` 的最后一行 Inline 按钮（跳过/取消）。
- 进入 `waiting_related_task` 阶段时，额外发送一条提示消息用于设置 ReplyKeyboard：
  - 菜单栏按钮：`跳过`、`取消创建任务`
- 保持任务列表消息继续使用 InlineKeyboard（任务选择、翻页）。
- 优点：交互与后续一致；无需滚动；语义清晰；风险可控。
- 缺点：进入该阶段会多发送一条提示消息（用于设置键盘）。

### 方案 C（最佳体验）
- 在方案 B 基础上：
  - 列表文案提示“请在菜单栏点击跳过/取消创建任务”；
  - 对“无效输入”提示中同样加入菜单栏引导；
  - 对旧消息残留的 Inline 回调（若用户点击历史消息）保持兼容，统一回复“已取消创建任务/已跳过”。
- 优点：学习成本最低、误操作更少。
- 缺点：文案与兼容逻辑更细，需要更全面测试。

> 推荐采用：方案 C（在 B 的基础上补齐文案与兼容），但实现复杂度仍然很低。

## 4. 推荐设计（落地到仓库的实现点）

### 4.1 新增键盘（ReplyKeyboard）
- 新增一个专用键盘构建函数（示例命名）：
  - `_build_related_task_action_keyboard()` → ReplyKeyboardMarkup
  - 按钮：`跳过`、`取消创建任务`
  - 复用 `_number_reply_buttons()` 保持与后续流程一致（允许点击按钮，也便于输入编号）。

### 4.2 进入关联选择阶段时的消息策略（关键点）
- 由于同一条消息不能同时挂 Inline + Reply：
  - 先发“操作提示消息”并设置 ReplyKeyboard（菜单栏按钮出现）
  - 再发“任务列表消息”并设置 InlineKeyboard（任务与翻页按钮）

### 4.3 关联选择视图调整
- `_build_related_task_select_view()`：
  - 删除最后一行 `[跳过, 取消]` 的 InlineKeyboardButton。
  - 文案调整：提示用户“可在菜单栏点击 跳过/取消创建任务”。

### 4.4 文本输入处理调整
- `on_task_create_related_task_text()`：
  - 支持识别“取消创建任务”并执行“取消创建任务”的动作（清理 state、返回主菜单）。
  - 保留对“取消”的兼容（用户手动输入取消仍然可用）。
  - “跳过”逻辑保持不变。

### 4.5 兼容旧 Inline 回调
- 保留 `on_task_create_related_skip()` / `on_task_create_related_cancel()` handler（即使 UI 不再生成该按钮），用于兼容历史消息点击。
- 将 callback 提示与消息文案统一改为“已取消创建任务”（避免再次产生歧义）。

## 5. 用例设计（像测试一样）

### 5.1 主流程
1) 创建任务 → 选择类型“缺陷” → 进入关联选择页  
   - 期望：菜单栏出现 `跳过 / 取消创建任务`；列表消息仅包含任务与翻页按钮
2) 点击某个任务作为关联  
   - 期望：进入“输入描述”阶段；菜单栏切换为描述阶段的键盘（跳过/取消）
3) 点击菜单栏“跳过”  
   - 期望：进入“输入描述”阶段（related_task_id=None）
4) 点击菜单栏“取消创建任务”  
   - 期望：直接退出创建流程并回到主菜单；状态清空

### 5.2 边界/异常
- 列表为空（无可选任务）
  - 期望：提示“当前无可选任务，可在菜单栏点击跳过继续”
- 用户输入无效内容（既不是 TASK_0001，也不是跳过/取消）
  - 期望：提示“任务编号无效…”并附带“可在菜单栏点击跳过/取消创建任务”引导
- 用户点击历史消息里的旧 Inline“取消/跳过”
  - 期望：仍能正确取消创建/跳过，且文案一致，不出现“取消关联任务”歧义

## 6. 测试清单（自动化建议）
- 更新 `tests/test_task_related_selection_view.py`
  - 断言不再生成最后一行 skip/cancel inline 按钮
  - 断言文案包含菜单栏提示（如有）
- 更新/新增 `tests/test_task_create_flow.py` 或相关 FSM 测试
  - 进入缺陷类型后，应额外发送“操作提示消息”（带 ReplyKeyboard）
  - “取消创建任务”文本输入应清 state 并回到主菜单
- 保持不变：翻页与选择关联任务的 Inline callback 流程

