# /TASK_0045 报告缺陷的流程需要修改下（Vibe）

> 前置关联文档：
> - `docs/TASK_0040_创建缺陷的流程.md`
> - `docs/TASK_0038_创建缺陷任务时的关联前置任务的交互优化.md`

## 1. 背景（现状）

当前在任务详情里点击「🚨 报告缺陷」后，会进入一个“记录缺陷信息”的流程；缺陷信息会被记录/推送，但不会像“创建任务”一样生成一个独立的「缺陷」类型任务，也不会在完成后立刻展示新缺陷任务详情。

## 2. 目标（用户期望）

将「报告缺陷」调整为：
1) 通过类似「创建任务」的交互创建一个「缺陷」类型任务；
2) 新缺陷任务自动关联触发入口的这条任务；
3) 创建完成后立即展示新创建的缺陷任务详情。

## 3. 用户/场景

- 谁：一线执行人员/测试/研发，在处理某个任务时发现问题需要记录。
- 什么时候：正在查看任务详情、准备同步缺陷信息的当下。
- 业务目标：快速“落一条缺陷任务”，并能立刻进入缺陷详情继续补充信息、追加附件、跟踪处理。

## 4. 方案选择（已确认 ✅）

> 用户选择：全部按模型推荐方案

1) 交互收集形态：A（最短路径：标题+描述为主）✅  
2) “父任务”关联展示口径：A（缺陷详情展示为「关联任务 = 触发任务」）✅  
3) 创建成功后的落点：A（直接展示新缺陷详情）✅  
4) 附件归属策略：B（附件只归属到新缺陷任务）✅  

## 5. 主流程（信息架构）

```text
任务详情(/TASK_xxxx)
  └─ 点击「🚨 报告缺陷」
	       └─ 创建缺陷任务（缺陷类型固定）
	            ├─ 输入：缺陷标题（必填）
	            ├─ 输入：缺陷描述（必填，可带附件）
	            ├─ 确认创建 / 取消
	            └─ ✅ 创建成功 → 立即展示【新缺陷任务详情(/TASK_yyyy)】
```

## 6. 关键规则（业务口径）

- 新缺陷任务类型固定为「缺陷」。
- 新缺陷任务与触发任务建立关联（在缺陷详情里可见“关联任务：/TASK_xxxx”）。
- 报告缺陷过程中上传的附件归属到新缺陷任务（便于后续排查与追踪）。

## 7. 验收标准（AC）

- 从任一任务详情点击「🚨 报告缺陷」后，进入“创建缺陷任务”的交互流程。
- 缺陷标题、缺陷描述均为必填；缺陷描述阶段支持发送图片/文件作为附件。
- 用户在流程任意阶段选择取消：不产生新缺陷任务，并返回主菜单。
- 创建成功后：立即展示新缺陷任务详情（用户无需手动输入任务编号）。
- 缺陷描述阶段上传的附件应归属到新缺陷任务，并可在新缺陷任务详情中查看。
- 新缺陷任务详情中可见其与触发任务的关联信息。
- 创建失败时：给出明确提示，并提供重试/取消选择。

---

## 8. 开发设计（Design）

### 8.1 现状定位（技术视角）

- 入口按钮：任务详情页动作区「🚨 报告缺陷」  
  - 位置：`bot.py:5233`（`_build_task_actions()`）
  - 回调入口：`bot.py:10994`（`on_task_bug_report()`）
- 当前实现：进入 `TaskBugReportStates`（`tasks/fsm.py:34`），按“缺陷描述/复现步骤/日志/确认提交”收集信息，并将附件绑定到**触发任务**，最终记录一条 `bug_report` 事件并尝试自动推送模型（`bot.py:11250`、`bot.py:5136`）。
- 任务关联字段现状：
  - `TaskRecord` 同时存在 `parent_id` 与 `related_task_id`（`tasks/models.py:49`）。
  - 但当前创建根任务 `create_root_task()` 会强制写入 `parent_id=NULL`（`tasks/service.py:431`），且仓库文案/交互已明确“子任务功能已下线”，因此本需求采用 **`related_task_id`** 表达“触发任务关联”更符合现状与风险最小。
- 任务详情展示已支持关联信息：
  - `bot.py:4762` `_format_task_detail()` 中已渲染 `🔗 关联任务：/TASK_xxxx`（当 `related_task_id` 存在时）。

### 8.2 目标交互（新流程）

> 目标：把“报告缺陷”变成“创建一个缺陷类型任务”的向导（体验对齐 `/task_new`），并在创建完成后立即展示新缺陷详情。

```text
触发任务详情 /TASK_xxxx
  └─ 点击「🚨 报告缺陷」
       ├─ ① 输入缺陷标题（必填，可取消）
       ├─ ② 输入缺陷描述（必填，可发送附件）
       ├─ ③ 确认创建（可取消；允许继续补充附件/文字）
       └─ ✅ 创建成功：立即展示新缺陷任务详情 /TASK_yyyy
```

交互细节（推荐落地口径）：
- 标题阶段：仅提供“取消”按钮（避免出现“跳过”误导）。
- 描述阶段：仅提供“取消”按钮；支持：
  - 发送纯文本作为描述；
  - 发送图片/文件作为附件（可先发附件，再补充描述文本；描述为空则继续提示必填）。
- 确认阶段：沿用“✅ 确认创建 / ❌ 取消”，并支持追加附件或补充文字（补充文字默认追加到描述末尾）。

### 8.3 数据与规则（与 vibe 口径一致）

- 新任务类型：`task_type = defect`
- 关联触发任务：`related_task_id = 触发任务.id`
- 附件归属：创建流程中上传的附件全部绑定到 **新缺陷任务**（不再绑定到触发任务）
- 历史留痕（建议保留，便于追溯）：
  - 在触发任务写入一条 `task_action`：`action=bug_report`，payload 中包含 `created_defect_task_id`
  - 保持任务历史 UI 中仍显示“报告缺陷”（现有摘要映射已支持：`bot.py:4951`）

### 8.4 模块改动点（实现清单）

> 说明：本阶段仅输出设计，不修改代码；具体实现将在 develop 阶段落地。

1) FSM 状态新增（推荐，避免破坏旧会话）
- 文件：`tasks/fsm.py`
- 新增 `StatesGroup`：例如 `TaskDefectReportCreateStates`
  - `waiting_title`
  - `waiting_description`
  - `waiting_confirm`

2) 入口改造（替换“旧缺陷上报”入口为“创建缺陷任务”入口）
- 文件：`bot.py`
- 修改 `on_task_bug_report()`：
  - 从“进入 TaskBugReportStates”改为“进入 TaskDefectReportCreateStates.waiting_title”
  - 在 state 中写入：`origin_task_id`（触发任务 ID）、`task_type=defect`、`related_task_id=origin_task_id`、`pending_attachments=[]`、`processed_media_groups=[]` 等

3) 新增三段 message handler（与 `/task_new` 风格对齐）
- `waiting_title`：校验标题必填；取消则 `state.clear()` 并回到主菜单。
- `waiting_description`：复用 `_collect_generic_media_group()` 收集附件；描述必填；超长校验复用 `DESCRIPTION_MAX_LENGTH`。
- `waiting_confirm`：
  - 展示摘要（标题/类型/关联任务/描述/附件列表）
  - 允许继续补充附件/文本（补充文本追加到描述末尾）
  - 确认后调用 `TASK_SERVICE.create_root_task(...)` 创建缺陷任务，并调用 `_bind_serialized_attachments()` 绑定附件
  - 清理 state，立即 `_render_task_detail(new_task.id)` 并发送详情
  - 同时对触发任务调用 `_log_task_action(origin_task_id, action=\"bug_report\", payload={created_defect_task_id: ...})`

4) 兼容性处理（推荐）
- 若用户仍处于旧 `TaskBugReportStates.*` 会话（升级前遗留）：
  - 任意输入时提示“报告缺陷流程已升级，请重新点击任务详情中的 🚨 报告缺陷”，并 `state.clear()` 回到主菜单（避免卡死）。

### 8.5 关键流程伪代码

```text
on_task_bug_report(task_id):
  origin = get_task(task_id)
  clear_state()
  state = {
    origin_task_id: origin.id,
    title: "",
    description: "",
    task_type: "defect",
    related_task_id: origin.id,
    pending_attachments: [],
    processed_media_groups: [],
    actor: reporter
  }
  set_state(waiting_title)
  ask("请输入缺陷标题（必填）", keyboard=[取消])

waiting_title(input):
  if cancel: clear + main_menu
  if empty: ask retry
  save title
  set_state(waiting_description)
  ask("请输入缺陷描述（必填，可发附件）", keyboard=[取消])

waiting_description(input + attachments):
  collect attachments -> pending_attachments
  if cancel: clear + main_menu
  if text empty: ask "描述不能为空"
  save description
  set_state(waiting_confirm)
  show summary + confirm keyboard

waiting_confirm(input + attachments):
  if cancel: clear + main_menu
  if attachments or extra text: update pending_attachments/description; re-show summary
  if confirm:
    create defect task (type=defect, related_task_id=origin_task_id)
    bind pending_attachments -> new task
    log origin action bug_report(created_defect_task_id)
    clear_state()
    show new task detail
```

### 8.6 用例设计（像测试一样 ✅）

主流程：
1) 从任务详情点击「🚨 报告缺陷」→ 进入“输入缺陷标题”
2) 输入标题 → 进入“输入缺陷描述”
3) 输入描述（可带附件）→ 进入“确认创建”
4) 点击“✅ 确认创建”→ 创建缺陷任务成功，并立刻展示新缺陷详情

取消与异常：
5) 标题阶段点击取消 → 不创建任务，返回主菜单
6) 描述阶段点击取消 → 不创建任务，返回主菜单
7) 确认阶段点击取消 → 不创建任务，返回主菜单
8) 标题为空/全空白 → 提示必填，不推进
9) 描述为空（即使先发了附件）→ 提示必填，允许继续补充描述
10) 描述超长 → 提示超长并要求重输

附件与媒体组：
11) 描述阶段发送单文件 → 在确认摘要的“附件列表”可见，且最终归属到新缺陷任务
12) 描述阶段发送相册媒体组 → 仅绑定一次，不重复入库（复用现有 media_group 去重策略）
13) 确认阶段追加附件/文字 → 更新摘要后仍可确认创建

追溯：
14) 创建成功后，触发任务历史中出现“报告缺陷”事件，payload 记录新缺陷任务 ID（用于可追溯）

### 8.7 测试计划（pytest）

目标：覆盖“创建缺陷任务 + 关联/附件归属/状态推进/取消/媒体组去重”。

推荐新增/调整用例方向：
- 新增：`tests/test_bug_report_create_defect.py`（或在现有 `tests/test_task_description.py` 中替换原 bug_report 测试）
  - 点击回调进入新 FSM，断言 state=waiting_title 且 related_task_id=origin
  - 标题必填校验与取消
  - 描述必填校验（含“先发附件后补文本”的路径）
  - 确认创建：断言调用 `TASK_SERVICE.create_root_task(task_type='defect', related_task_id=origin)`
  - 断言 `_bind_serialized_attachments()` 绑定到 **新任务**（而非 origin）
  - 断言最终发送了新任务详情（`_render_task_detail(new_task.id)`）
  - 断言对 origin 写入 `_log_task_action(action='bug_report', payload.created_defect_task_id)`

### 8.8 参考资料（官方/可验证）

- Telegram Bot API：ReplyKeyboardMarkup / InlineKeyboardMarkup（用于说明键盘交互约束）  
  https://core.telegram.org/bots/api#replykeyboardmarkup  
  https://core.telegram.org/bots/api#inlinekeyboardmarkup
- 本仓库可验证的实现位置（便于 review）  
  - 报告缺陷入口：`bot.py:10994`  
  - 创建任务流程：`bot.py:9432`、`bot.py:9769`、`bot.py:9841`  
  - 任务模型字段：`tasks/models.py:49`  
  - 根任务创建写入 parent_id=NULL：`tasks/service.py:431`

---

## 9. 开发实现（Develop）✅

### 9.1 交付物清单

- `tasks/fsm.py`
  - 新增：`TaskDefectReportStates`（标题/描述/确认三段状态）
- `bot.py`
  - 改造：`on_task_bug_report()` 从“旧缺陷上报”切换为“创建缺陷任务”新流程
  - 新增：`on_task_defect_report_title()` / `on_task_defect_report_description()` / `on_task_defect_report_confirm()`
  - 新增：`_build_defect_report_intro()`（新流程开场提示）
  - 保留：旧 `TaskBugReportStates` 相关 handler（仅为兼容/历史逻辑保留，不再由按钮入口触发）
- `tests/test_defect_report_flow.py`
  - 新增：报告缺陷→创建缺陷任务流程的单元测试覆盖

### 9.2 关键实现口径（与需求一致）

- 「🚨 报告缺陷」= 创建一个 `task_type=defect` 的新任务
- 新缺陷任务自动关联触发任务：使用 `related_task_id = origin_task_id`
- 附件归属：创建流程中上传的附件仅绑定到新缺陷任务（确认创建后统一绑定）
- 创建成功后：立即展示新缺陷任务详情（不提供“返回触发任务”按钮）
- 追溯：在触发任务历史中记录一次 `bug_report` 事件，并在 payload 中写入 `created_defect_task_id`

### 9.3 自测记录

自动化测试（已执行）：
```bash
.venv/bin/python -m pytest -q
```
结果：✅ 528 passed

手工冒烟（建议你在 Telegram 验证）：
```text
1) 打开任意任务详情
2) 点击「🚨 报告缺陷」
3) 输入缺陷标题（必填）
4) 输入缺陷描述（必填，可先发附件再补描述）
5) 点击「✅ 确认创建」
6) 期望：立刻展示新创建的缺陷任务详情（含关联任务字段）
```
