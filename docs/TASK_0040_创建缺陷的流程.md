# /TASK_0040 创建缺陷的流程（Design）

## 1. 背景与目标

用户反馈（已复现截图）：

1) 创建缺陷时，在“选择关联前置任务”阶段，期望跳过关联任务，直接输入了 `1`，却被提示“任务编号无效”；目前只能点击菜单栏的“跳过”按钮才可以继续。
2) 最终“请确认任务信息”提示中，应展示本次创建所携带的**附件列表**，便于确认后再创建。

目标（按用户确认的推荐口径）：
- 关联选择阶段支持数字快捷输入：
  - `1 = 跳过`
  - `2 = 取消创建任务`
- “请确认任务信息”摘要中展示附件列表：
  - 格式：`文件名（MIME）→ 本地路径`
  - 超出预览数量时截断并标注总数
  - 统计范围：创建流程中累计收集到的全部附件（按发送顺序）

## 2. 现状定位（技术视角）

### 2.1 关联任务选择阶段

- 菜单栏键盘：`bot.py:_build_related_task_action_keyboard()`（ReplyKeyboard，且会加数字前缀）
- 文本输入处理：`bot.py:on_task_create_related_task_text()`  
  - 当前仅识别文本 `跳过/取消创建任务`，以及 `TASK_0001`；当用户输入 `1` 时会走到“任务编号无效”分支。
- 数字编号解析能力：`bot.py:_resolve_reply_choice()`  
  - 已支持把纯数字 `1/2/...` 映射到 options 列表，但 `on_task_create_related_task_text()` 目前未使用该函数。

### 2.2 “请确认任务信息”摘要

- 摘要构建位置：`bot.py:on_task_create_description()` 进入 `TaskCreateStates.waiting_confirm` 后拼接 `summary_lines`。
- 附件采集位置：
  - 描述阶段：`bot.py:on_task_create_description()` 会把附件序列化写入 `state.pending_attachments`
  - 确认阶段：`bot.py:on_task_create_confirm()` 允许继续追加附件/描述到 `pending_attachments/description`
- 当前摘要未包含 `pending_attachments` 的渲染，因此用户看不到附件列表。

## 3. 修复方案（推荐 ✅）

### 3.1 关联任务选择阶段支持 “1 跳过 / 2 取消”

改动点：
- 在 `on_task_create_related_task_text()` 中引入 `_resolve_reply_choice()`，用 `options=[SKIP_TEXT, "取消创建任务"]` 解析用户输入：
  - 用户输入 `1` → 解析为 `跳过` → 进入跳过逻辑
  - 用户输入 `2` → 解析为 `取消创建任务` → 进入取消逻辑
  - 仍支持输入 `TASK_0001` 选择关联任务

同时优化提示文案（避免再次困惑）：
- 无效输入提示改为：支持输入 `TASK_0001`，或输入 `1/2`（对应跳过/取消）。

### 3.2 确认摘要展示附件列表（并在确认阶段追加后可更新）

改动点（最小且闭环）：
- 在 `on_task_create_description()` 构建 `summary_lines` 时，读取 `pending_attachments`：
  - 无附件：`附件列表：-`
  - 有附件：输出 `附件列表：` + `1. xxx（mime）→ path`，最多展示 `TASK_ATTACHMENT_PREVIEW_LIMIT` 条；超出则 `… 其余 N 个附件未展开（共 M 个）`

增强点（为覆盖“确认阶段追加附件”场景，推荐一起做）：
- 在 `on_task_create_confirm()` 的“已记录补充的描述/附件”分支中，追加一条“当前确认信息摘要（含附件列表）”或重发摘要，确保用户最终看到最新附件列表再确认。

## 4. 用例设计（像测试一样）

### 4.1 主流程
1) 创建缺陷 → 进入“选择关联前置任务”
2) 用户输入 `1`
   - 期望：等价于点击“跳过”；进入描述输入阶段
3) 用户输入 `2`
   - 期望：等价于点击“取消创建任务”；流程结束并回到主菜单

### 4.2 附件展示
4) 描述阶段发送图片/文件作为附件后进入确认摘要
   - 期望：摘要中出现“附件列表”并展示 `文件名（MIME）→ 路径`
5) 确认阶段再追加附件/描述
   - 期望：提示“已记录补充…”后能看到最新附件列表（至少可通过更新后的摘要消息确认）

### 4.3 边界
- 输入 `TASK_0001`：仍可选择关联任务
- 输入无效文本：提示应包含“可输入 TASK_0001 或输入 1/2”

## 5. 自动化测试清单（pytest）

优先复用现有测试文件，最小增量：
- `tests/test_task_create_flow.py`
  - 新增：`waiting_related_task` 状态下，输入 `1` 应跳过并推进到描述阶段（可 monkeypatch `_advance_task_create_to_description` 或断言 state 变化）
  - 新增：输入 `2` 应清 state 并回到主菜单
  - 更新：附件绑定相关用例，断言“确认摘要”包含附件列表条目（如 `log.txt`）
- `tests/test_numbered_reply_inputs.py`
  - 新增：为“关联任务阶段菜单 options”补充 `_resolve_reply_choice()` 的数字映射断言（`1/2`）

## 6. 参考资料（官方/可验证）

- Telegram Bot API：`reply_markup` 与键盘类型互斥（同一条消息不能同时挂 Inline + Reply）  
  https://core.telegram.org/bots/api#sendmessage  
  https://core.telegram.org/bots/api#replykeyboardmarkup  
  https://core.telegram.org/bots/api#inlinekeyboardmarkup

