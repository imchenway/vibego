# /TASK_0052 报告缺陷时为什么提示两遍输入缺陷描述（YOLO）

## 0. 摘要
- 现象：在「🚨 报告缺陷（创建缺陷任务）」流程里，机器人先提示一次“请输入缺陷描述（可选）…”，用户发送截图/附件后又再次提示一次“缺陷描述可选…”，看起来像重复提示两遍。
- 原因：描述阶段把“仅附件、无文字”的输入当作“缺少描述”，从而再次发送提示文案。
- 结果：当用户在描述阶段**仅发送附件（无文字）**时，直接进入“确认创建”阶段（确认阶段仍可继续补充文字/附件），避免重复提示。

## 1) vibe 阶段（需求调研/问题分析）

### 1.1 用户视角复现（可验证）
1) 进入某任务详情，点击「🚨 报告缺陷」
2) 输入缺陷标题后，机器人提示输入“缺陷描述（可选）”
3) 用户发送图片/文件附件（未带 caption 文本）
4) 机器人再次提示“缺陷描述可选…（可继续输入/跳过）”

> 佐证：用户提供的截图中，附件消息后立即出现第二次“缺陷描述可选…”提示。

### 1.2 根因假设（至少两种）
- 假设 A（高置信 ✅）：描述阶段仅依赖“文本内容”判断是否完成；当输入为“附件但无文字”时被判定为“空输入”，触发再次提示。
- 假设 B（中高置信 ✅）：Telegram 的媒体组/附件消息可能触发多次 handler；若未正确识别“已收到有效输入”，会造成重复提示（尤其是媒体组多图场景）。

## 2) design 阶段（开发设计 + 用例设计）

### 2.1 方案对比
- 方案 A：收到仅附件时仍停留在描述阶段，但只回“已收到附件”不再重复提示。
  - 优点：不改变流程推进节奏
  - 缺点：用户仍需要手动发送“跳过”进入确认；交互步骤更多
- 方案 B（采用 ✅）：收到仅附件时直接进入确认阶段（描述为空），并在确认阶段允许继续补充文字/附件。
  - 优点：减少一次交互与重复提示；与“描述可选”一致；确认阶段已支持补充
  - 风险：用户可能期望继续发附件再统一确认，但确认阶段同样支持继续补充，风险可控

### 2.2 验收标准（AC）
1) 描述阶段提示“缺陷描述可选”只出现一次（进入描述阶段时）。
2) 在描述阶段仅发送附件（无文字）时，直接进入确认创建阶段，不再二次提示输入描述。
3) 确认阶段仍可继续追加附件/文字；“跳过”仍可用；“取消”仍可用。

## 3) develop 阶段（需求开发/问题修复）

### 3.1 变更点（可验证）
- `bot.py`
  - 描述阶段提示语补充说明：“仅发送附件也会进入下一步”
  - 描述 handler：当 `trimmed==""` 且本次消息包含附件时，直接进入确认阶段；只有在“既无文字也无附件”时才再次提示
- `tests/test_defect_report_flow.py`
  - 更新用例：描述阶段“仅附件无文字”应直接进入确认阶段，并展示确认创建提示

### 3.2 自测记录（可验证）

```bash
.venv/bin/python -m pytest -q
```

结果：`536 passed`

## 4) 参考资料（官方/可验证）
- Telegram Bot API：Message 字段（`caption` / `media_group_id` 等）  
  https://core.telegram.org/bots/api#message
- aiogram 文档：Message/Router/FSM 使用说明  
  https://docs.aiogram.dev/

