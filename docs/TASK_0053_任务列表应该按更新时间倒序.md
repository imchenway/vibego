# /TASK_0053 任务列表应该按更新时间倒序（YOLO）

## 0. 摘要
- 目标：Worker 端「📋 任务列表」/`/task_list` 的任务展示顺序应为 **按更新时间倒序**（最近更新优先）。
- 根因：任务列表分页查询使用 `TaskService.list_tasks()`，其 SQL 之前按 `lineage ASC` 排序，导致更像“按创建/层级顺序”而不是“最近更新”。
- 结果：将列表排序改为 `updated_at DESC, id DESC`；新增单测覆盖“旧任务更新后置顶”。

---

## 1) vibe 阶段（需求调研/问题分析）

### 1.1 用户视角现状
- 打开「📋 任务列表」时，列表顶部并不总是最近刚更新/刚操作过的任务。
- 用户期望：最近更新的任务应排在最前面，便于继续跟进。

### 1.2 验收标准（AC）
1) 任务列表默认按 `updated_at` 倒序展示。
2) 当较旧任务发生更新（例如修改标题/状态等），其应在列表中置顶（在同页容量内可见）。
3) 分页与状态筛选仍可用。

---

## 2) design 阶段（开发设计 + 用例设计）

### 2.1 现状定位（可验证）
- 任务列表视图：`bot.py:_build_task_list_view()` 调用 `TASK_SERVICE.paginate()` 取列表数据。
- 分页实现：`tasks/service.py:TaskService.paginate()` 内部调用 `TaskService.list_tasks()`。
- 原排序：`TaskService.list_tasks()` 之前为 `ORDER BY lineage ASC`，未按更新时间排序。

### 2.2 方案选择
- 方案 A：仅改 bot 层对返回结果排序（内存排序）。
  - ❌ 缺点：分页不稳定（排序发生在分页之后），且会加重 bot 层逻辑。
- 方案 B（采用 ✅）：在 DB 查询层改排序为 `updated_at DESC`（必要时以 `id` 作为稳定二级排序）。
  - ✅ 优点：分页稳定、逻辑集中、与“关联任务选择视图（最近更新优先）”一致。

### 2.3 用例设计（像测试一样）
- 创建 6 条任务（创建时间递增）。
- 更新最早创建的任务，使其 `updated_at` 最新。
- 拉取任务列表第一页，断言该任务排在第一位。

---

## 3) develop 阶段（需求开发/问题修复）

### 3.1 代码改动（可验证）
- `tasks/service.py`
  - `list_tasks()` 排序从 `lineage ASC` 改为 `updated_at DESC, id DESC`
- `tests/test_task_list_entry.py`
  - 新增：`test_task_list_view_sorts_by_updated_at_desc`（覆盖“旧任务更新后置顶”）

### 3.2 自测记录（可验证）

```bash
.venv/bin/python -m pytest -q
```

结果：`537 passed`

---

## 4) 参考资料（官方/可验证）
- SQLite `ORDER BY` 语法： https://www.sqlite.org/lang_select.html#orderby
- SQLite 日期时间函数（ISO-8601 文本存储/解析）： https://www.sqlite.org/lang_datefunc.html

