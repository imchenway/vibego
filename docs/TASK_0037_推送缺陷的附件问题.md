# /TASK_0037 推送缺陷的附件问题（Design 设计说明）

## 1. 背景与目标

### 背景
- 在「推送到模型」流程中，用户在“补充任务描述”阶段输入/随附的图片地址（通常来自图片消息的 caption 或仅发送附件）没有体现在最终推送信息块的 `补充任务描述` 字段中，导致模型侧缺少关键上下文。

### 目标（来自 vibe 阶段已确认）
- 推送信息面向：模型 + Telegram 预览，两者内容一致。
- 图片/附件信息需要在两处体现：
  - `补充任务描述`：仅附件无文字时显示 `见附件：<文件名列表>`（按发送顺序）。
  - `附件列表`：保持现有格式不变（含 MIME 与路径；超出限制时保留“其余未展开”提示）。
- 路径策略：允许展示完整绝对路径。
- 权限：所有管理员可补充/推送。
- 图片来源：上传附件 + 粘贴 URL 都支持（URL 属于补充文本的一部分）。

## 2. 现状定位（技术视角）

### 关键入口与调用链
1) 用户点击内联按钮「🚀 推送到模型」  
   - 入口：`bot.py:9918` `on_task_push_model()`
2) research/test 状态需要补充说明，进入 FSM  
   - 状态：`tasks/fsm.py:50` `TaskPushStates.waiting_supplement`
3) 用户发送补充消息（文字/图片/文件/相册）后处理并推送  
   - 入口：`bot.py:10058` `on_task_push_model_supplement()`
4) 构建推送 prompt  
   - `bot.py:1650` `_push_task_to_model()`
   - `bot.py:4306` `_build_model_push_payload()`

### 现状行为（与缺陷相关）
- `on_task_push_model_supplement()` 仅读取 `message.text` 作为补充文本（`bot.py:10060`），没有读取 `message.caption`。  
  - 结果：用户发送“图片+caption（含图片地址/URL）”时，caption 会丢失，推送块里 `补充任务描述` 变成 `-`。
- 当用户“仅发送附件（无文字）”时，`supplement` 保持 `None`，最终 `补充任务描述` 仍显示 `-`（`bot.py:4357`）。
- 当前补充阶段未使用媒体组聚合逻辑；相册会触发多次 handler，存在“只采集到部分附件/重复触发/状态被清空后误提示”的潜在风险。  
  - 参考仓库已存在的聚合实现：`bot.py:2298` `_collect_generic_media_group()`（用于任务创建/附件绑定等流程，能合并 caption，并确保媒体组仅消费一次）。

## 3. 根因分析

根因是 **补充阶段文本提取不完整**：
- Telegram 对于图片/文件消息，用户输入的文字通常位于 `caption` 字段，而不是 `text` 字段。当前逻辑忽略了 `caption`（`bot.py:10060`）。
- “仅附件无文字”场景未对 `supplement` 做业务兜底，因此推送块 `补充任务描述` 无法体现附件线索。

可验证资料：
- Telegram Bot API `Message` 字段说明（`text` vs `caption`）：https://core.telegram.org/bots/api#message
- `sendPhoto`/`sendDocument` 中 `caption` 字段：  
  - https://core.telegram.org/bots/api#sendphoto  
  - https://core.telegram.org/bots/api#senddocument

## 4. 方案对比（至少 3 种）

### 方案 A：最小改造（仅修 caption + 仅附件兜底）
- 做法：
  - `on_task_push_model_supplement()` 读取 `message.caption or message.text`。
  - 若无文字且本次消息携带附件，则自动生成 `supplement="见附件：<文件名…>"`。
- 优点：改动最小、风险低。
- 缺点：相册/媒体组仍可能触发多次 handler，存在“只采集到部分附件/重复推送”的边缘问题。

### 方案 B：推荐方案（caption + 媒体组聚合 + 仅附件兜底 ✅）
- 做法：
  - 补充阶段复用 `_collect_generic_media_group()`，统一得到：
    - `saved_attachments`：整组附件（去重后）
    - `text_part`：合并后的 caption/text
  - 若 `text_part` 非空且非“跳过”，作为补充文本；
  - 若 `text_part` 为空且 `saved_attachments` 非空，生成 `supplement="见附件：<文件名列表>"`；
  - 媒体组重复回调时直接忽略，避免状态被清理后误报“会话失效”。
- 优点：补齐本缺陷，同时把相册场景做稳定；与仓库既有实现一致，维护成本低。
- 缺点：媒体组场景会引入约 `TELEGRAM_MEDIA_GROUP_DELAY`（默认约 0.8s）的聚合等待（仅媒体组）。

### 方案 C：最佳实践（结构化推送上下文 + 可追溯）
- 做法：
  - 将“补充文本 + 本次补充附件列表”作为结构化数据落库（例如新增 `task_push_context` 表或在 `task_history` 增强 payload）。
  - 推送时读取并渲染，保证审计/回溯。
- 优点：可追溯性最好，后续可扩展“多次补充”“对比推送”等能力。
- 缺点：涉及 DB/迁移与更多改动，不符合本缺陷的最小修复原则。

**推荐选择：方案 B**（在不改 DB 的前提下，把 caption 丢失与媒体组边缘一起收敛）。

## 5. 详细设计（方案 B）

### 5.1 影响范围
- 主要修改：`bot.py`
  - `on_task_push_model()` / `on_task_push_model_fill()`：在进入 `waiting_supplement` 时初始化 `processed_media_groups=[]`（与其他流程一致）。
  - `on_task_push_model_supplement()`：改为使用 `_collect_generic_media_group()`，并补齐 `caption`、仅附件兜底与媒体组重复回调忽略。
- 不改动：
  - SQLite schema（`tasks/service.py`）
  - 附件落盘目录/命名逻辑（`bot.py:_download_telegram_file()` 等）
  - 推送信息的字段格式（`bot.py:_build_model_push_payload()` 保持原模板）

### 5.2 关键逻辑伪代码
```python
data = await state.get_data()
processed = set(data.get("processed_media_groups") or [])
attachment_dir = _attachment_dir_for_message(message)

saved, text_part, processed = await _collect_generic_media_group(message, attachment_dir, processed=processed)
if message.media_group_id and not saved and not text_part:
    return  # 媒体组重复回调，直接忽略
if message.media_group_id:
    await state.update_data(processed_media_groups=list(processed))

raw_text = (text_part or message.caption or message.text or "").strip()
resolved = _resolve_reply_choice(raw_text, options=[SKIP_TEXT, "取消"])

if resolved == "取消":
    ... cancel ...

supplement = None
if raw_text and resolved != SKIP_TEXT:
    supplement = raw_text  # 这里仍做 DESCRIPTION_MAX_LENGTH 校验
elif saved:
    names = [a.display_name for a in saved]
    supplement = "见附件：" + "、".join(names[:TASK_ATTACHMENT_PREVIEW_LIMIT]) + optional_count_suffix

if saved:
    await _bind_serialized_attachments(task, serialize(saved), actor=actor)

await _push_task_to_model(... supplement=supplement ...)
```

### 5.3 “见附件：文件名列表”格式规则
- 分隔符：使用 `、`（中文顿号）
- 数量控制：最多展示前 `TASK_ATTACHMENT_PREVIEW_LIMIT` 个文件名；若超出则追加 `（共 N 个）`。
- 示例：
  - 1 个：`见附件：20260109_011317502-1bbd6294386f.jpg`
  - 7 个：`见附件：a.jpg、b.jpg、c.jpg、d.jpg、e.jpg（共 7 个）`

## 6. 用例设计 & Checklist（像测试一样）

### 6.1 覆盖用例（正常/边界/异常）
- 正常：补充阶段发送纯文本（message.text）
  - 期望：`补充任务描述` 为该文本；附件列表按原逻辑。
- 正常：补充阶段发送“图片 + caption（含 URL/图片地址）”
  - 期望：补充文本来自 `caption`；附件被绑定；推送块 `补充任务描述` 显示 caption。
- 正常：补充阶段仅发送图片/文件（无文字）
  - 期望：`补充任务描述` 显示 `见附件：<文件名...>`；`附件列表` 保持原格式。
- 正常：补充阶段发送相册（媒体组）多图无 caption
  - 期望：仅推送一次；`见附件` 列出本组文件名；附件仅绑定一次（不重复）。
- 边界：caption 仅空白/换行
  - 期望：按“无文字”处理，走 `见附件` 兜底。
- 边界：caption 超过 `DESCRIPTION_MAX_LENGTH`
  - 期望：提示用户重新输入，不触发推送。
- 异常：推送会话已失效（state 缺失 task_id）
  - 期望：提示重新点击按钮；媒体组重复回调不会误触发该提示。

### 6.2 自动化测试建议（pytest）
- 更新/新增用例位置：`tests/test_task_description.py`
  - 新增：caption 场景（message.text=None, message.caption 有值）应作为 supplement 传入 `_push_task_to_model`
  - 新增：仅附件无文字场景应生成 `supplement.startswith("见附件：")`
  - 可选：媒体组重复回调的“忽略”路径（可通过模拟 `media_group_id` + `_collect_generic_media_group` 返回空来覆盖）

## 7. 非功能性考虑
- 性能：媒体组聚合仅对相册生效；单消息仍为 O(1) 路径。
- 并发：复用现有 `BUG_MEDIA_GROUP_LOCK`；在极端高并发下可能成为热点，但当前 bot 的典型吞吐远低于该阈值。
- 安全：补充字段只拼文件名，不新增路径暴露面；附件列表仍按既有策略展示（用户已确认允许绝对路径）。

## 8. 回滚策略
- 回滚代码点集中在 `bot.py` 的补充推送 handler 与相关状态初始化；一旦出现问题，可快速回退到“仅 message.text + 不生成见附件”的旧逻辑。

