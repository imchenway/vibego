# /TASK_0041 模型回复底部快捷回复按钮（Design）

## 1. 背景与目标

在模型输出包含较多“待决策/待确认”的多选项问题时，用户往往需要逐条输入 `1A 2C 3B ...`，效率偏低且容易漏填。

本任务目标是在 **“模型真正的回复答案消息”** 底部提供快捷按钮，用于：
- ✅ 一键“全部按推荐”
- 🧩 “部分按推荐，只补充例外项”

## 2. 用户已确认口径（vibe 阶段结论）

### 2.1 出现位置（消息类型维度，关键）

Telegram 内会出现多种消息（命令执行结果、收到消息的确认回复、模型答案等）。

本需求仅针对 **模型真正的回复答案**：
- ✅ 仅在 session watcher 投递的模型输出消息上出现按钮
- ❌ 不出现在：命令执行结果、会话 ack（“思考中”）、终端实况、任务管理等其它系统消息

### 2.2 大消息降级为文件时的按钮位置

当模型答案过长，当前实现会降级为 `.md` 附件发送。此场景要求：
- ✅ 按钮挂在“文件消息”下方即可（不要求挂在摘要提示消息上）

### 2.3 点击后的回显与风险口径

- 点击后立即生效（不二次确认）。
- 回显方式：模拟“已推送到 tmux/模型”的体验，展示一条“等价用户输入”的文本摘要。
- 无法撤销：因为点击后内容会立即注入 tmux；如需纠正，只能再次发送纠正消息覆盖。

### 2.4 触发识别不依赖完整关键词

不要求模型一定输出完整的“待决策项”关键字；应以 **结构化特征** 识别出“编号题目 + A/B/C/D 选项”的决策块。

## 3. 现状定位（技术视角）

### 3.1 模型输出投递链路（只在这里挂按钮）

- session watcher 读取会话文件增量事件：`_read_session_events(...)`
- 发送模型输出：`_deliver_pending_messages(...)`
  - 仅当 `deliverable.kind == message` 才会进入发送逻辑
  - 当前发送函数：`reply_large_text(chat_id, formatted_text)`

### 3.2 长文本降级为文件的现状

`reply_large_text(...)` 当前策略：
1) 先发一条摘要消息（`send_message`）
2) 再发 `.md` 文件（`send_document`）

现状问题：`send_document` 未附带 `reply_markup`，因此文件模式下无法在文件消息底部展示按钮。

## 4. 交互设计（用户视角）

### 4.1 模型答案消息底部（InlineKeyboard）

在模型答案消息底部追加两枚按钮：
- `✅ 全部按推荐`
- `🧩 部分按推荐（补充例外）`

### 4.2 文件模式（答案降级为 .md）

当答案以 `.md` 文件发送时：
- 在“文件消息”下方展示同样的两枚按钮
- 摘要提示消息不挂按钮

### 4.3 点击按钮后的对话流（纯文本示意）

```text
模型答案（含待决策项）
  [✅ 全部按推荐] [🧩 部分按推荐（需补充）]

点击 ✅ 全部按推荐
  -> bot 回显：已推送到模型：`1A 2C 3B ...`
  -> 注入 tmux 并继续 watcher

点击 🧩 部分按推荐（需补充）
  -> bot 提示：请发送补充说明（自然语言），未提及默认按推荐；支持“跳过/取消”
  -> 用户发送补充说明（或发送“跳过/空消息”表示全部按推荐）
  -> bot 回显：已推送到模型：`待决策项部分按模型推荐...`（含“未提及都按推荐”规则）
  -> 注入 tmux 并继续 watcher
```

## 5. “待决策项”结构化识别规则（不依赖固定关键词）

### 5.1 识别目标

从模型输出文本中识别出一组“决策题”，每题包含：
- 题号：`1..N`
- 选项：`A/B/C/D`（至少出现 2 个选项才算有效决策题）
- 推荐选项：选项行中包含“推荐”字样（兼容 `推荐🌟/推荐✅/（推荐）` 等）

### 5.2 推荐解析结果的用途

- 用于生成“全部按推荐”的等价回复（如 `1A 2C 3B`）
- 用于“部分按推荐”时生成默认选择，并在用户输入例外项后覆盖

### 5.3 解析失败的降级策略（保证按钮可用）

若无法完整解析题号/推荐选项：
- `✅ 全部按推荐`：向模型发送口令式回复 `待决策项全部按模型推荐`
- `🧩 部分按推荐`：在用户输入例外后，向模型发送 `除以下例外外其余按推荐：3B 7D`

同时在 Telegram 回显中明确提示“解析不完整，已按口令发送”，避免误解为已生成完整 `1A 2C ...`。

## 6. 回调协议与状态管理（实现设计）

### 6.1 callback_data 长度约束（官方）

InlineKeyboardButton 的 `callback_data` 最大 **1-64 bytes**，因此不能把整段决策内容塞进回调参数里。
- https://core.telegram.org/bots/api#inlinekeyboardbutton

### 6.2 设计：短 token + 内存上下文

在发送每条“模型答案消息”时：
1) 解析该条答案，生成 `DecisionContext`
2) 生成短 token（如 `8-12` 字符）
3) 内存中保存：`token -> DecisionContext`（按 chat_id 分桶，带 TTL 清理）
4) 按钮回调仅携带 token：
   - `model:quick:all:<token>`
   - `model:quick:partial:<token>`

### 6.3 “部分按推荐”的交互状态

需要一个短暂的“等待用户输入补充说明（自然语言）”的状态（建议用 FSM state 或 chat 级别内存标记）：
- 保存：`chat_id -> pending_token`
- 超时：例如 10 分钟未输入则自动失效
- 失效提示：提示用户重新点击按钮

### 6.4 注入 tmux 的统一方式

复用现有 `_dispatch_prompt_to_model(...)`，保证：
- 自动注入 `ENFORCED_AGENTS_NOTICE`
- 复用 watcher、session 绑定与 ack 行为

Telegram 回显复用现有 `_send_model_push_preview(...)` 的文案风格（“已推送到模型：...”）。

## 7. 验收标准（AC，可测试）

1) 仅在模型答案消息（含文件模式）出现按钮；其它系统消息不出现。
2) 文件模式下按钮挂在“文件消息”下方（`send_document` 带 `reply_markup`）。
3) 点击 `✅ 全部按推荐` 会向 tmux 注入等价回复，并在 Telegram 回显“已推送到模型：...”；无二次确认。
4) 点击 `🧩 部分按推荐（需补充）` 会先提示用户输入补充说明；输入后向 tmux 注入“部分按推荐 + 未提及都按推荐规则 + 补充说明”，并回显。
5) 解析失败时按降级策略发送口令，并在回显中提示“解析不完整”。
6) 旧按钮过期/上下文缺失时，点击会明确提示“已失效，请重新点击或手动回复”。

## 8. 用例设计（像测试一样）

### 8.1 主流程（文本答案）
1) 模型答案包含 3 条决策题（含推荐）
2) 断言：消息底部出现两个按钮
3) 点击 `✅ 全部按推荐`
   - 断言：bot 回显包含 `已推送到模型` + `1A 2C 3B`
   - 断言：tmux 收到注入（可通过 mock `tmux_send_line` 验证）

### 8.2 主流程（文件答案）
1) 模型答案过长，降级为 `.md`
2) 断言：按钮挂在文件消息下方
3) 点击 `✅ 全部按推荐` 行为同上

### 8.3 部分按推荐（补充说明）
1) 点击 `🧩 部分按推荐（需补充）`
2) bot 提示输入补充说明（自然语言），并说明“未提及默认按推荐”
3) 用户输入：`只有第 3 个不按推荐，其余按推荐`
4) 断言：最终注入包含“规则：未提及的决策项全部按推荐”+“补充说明：...”

### 8.4 异常/边界
- 补充说明为空/发送“跳过”：等价 `✅ 全部按推荐`
- 补充说明过长：提示重新输入
- token 过期：提示重新点击
- 无决策题的普通模型答案：不展示按钮（或展示但点击提示“未识别到待决策项”，以最终实现口径为准）

## 9. 参考资料（官方/可验证）

- `sendMessage`：`reply_markup` 可挂 InlineKeyboard  
  https://core.telegram.org/bots/api#sendmessage
- `sendDocument`：文件消息同样支持 `reply_markup`  
  https://core.telegram.org/bots/api#senddocument
- InlineKeyboardMarkup  
  https://core.telegram.org/bots/api#inlinekeyboardmarkup
- InlineKeyboardButton `callback_data` 1-64 bytes  
  https://core.telegram.org/bots/api#inlinekeyboardbutton
