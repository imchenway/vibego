# /TASK_0039 微信二维码预览功能

## 背景

用户反馈：在已配置微信开发者工具 IDE HTTP 服务端口为 `45927` 的情况下，点击/触发 `wx-dev-preview`（生成预览二维码）仍提示“使用 45927 并重试”，导致重复提示、无法直接进入生成流程。

## 现象（用户视角）

- 触发生成二维码后，机器人返回“端口配置缺失（可恢复）”，并建议端口 `45927`。
- 但本机配置文件 `~/.config/vibego/config/wx_devtools_ports.json` 中已经存在 `45927` 的映射。

## 已知配置（可验证）

端口映射文件：`~/.config/vibego/config/wx_devtools_ports.json`

```json
{
  "projects": {
    "hyphamall": 45927
  },
  "paths": {
    "/Users/david/hypha/mall/frontend-mini": 45927
  }
}
```

## 初步结论（高置信度）

脚本 `scripts/gen_preview.sh` 在解析项目/端口映射时调用的是 `python` 命令；当系统仅有 `python3` 而没有 `python` 时，脚本会静默解析失败（stderr 被丢弃且 `|| true`），从而把“已配置的端口”误判为“未配置端口”，触发“端口配置缺失”的交互提示。

可验证点：
- `scripts/gen_preview.sh` 中存在 `python ... 2>/dev/null` 的调用（用于解析 `miniprogramRoot` 与 `wx_devtools_ports.json`）。
- 本机环境 `command -v python` 可能为空，但 `python3` 存在。

## 修复进展（已完成✅）

- ✅ `scripts/gen_preview.sh` 改为自动选择可用的 Python3 解释器（优先 `VIRTUAL_ENV/bin/python`，其次 `python3.*`/`python3`），避免因系统缺少 `python` 导致“端口缺失”误判。
- ✅ 追加回归测试：模拟“python 存在但不可用”的环境，确保仍能用 python3 解析端口配置并把 `--port` 传入 CLI。

涉及文件（可回溯）：
- `scripts/gen_preview.sh`
- `tests/test_wx_preview_port_flow.py`

## 临时规避（不改代码）

- 让 `python` 在 PATH 中可用（例如提供 `python -> python3` 的可执行入口），或
- 触发命令时临时显式设置 `PORT=45927`（仅单次生效）。

## 参考资料（官方/可验证）

- 微信开发者工具 CLI（`--port`/服务端口）：https://developers.weixin.qq.com/miniprogram/dev/devtools/cli.html
- Python 关于 `python` 命令名约定（PEP 394）：https://peps.python.org/pep-0394/
