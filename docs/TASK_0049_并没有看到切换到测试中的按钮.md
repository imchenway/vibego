# /TASK_0049 并没有看到切换到测试中的按钮（PLAN）

## 1) vibe 阶段（需求调研/问题分析）

### 1.1 用户反馈（现象）
- 用户反馈：**“并没有看到切换到测试中的按钮”**。
- 关联背景：`/TASK_0047` 已设计在“模型答案消息”底部增加 **🧪 一键切到测试** 的入口，用于替代此前“生成摘要并自动切 test”的入口。

### 1.2 期望行为（用户视角）
- 在阅读“模型答案消息”时，无需跳转任务详情，也能一键把当前任务状态更新为 **🧪 测试中**。

### 1.3 现状定位（可验证证据）
- “模型答案消息”底部键盘构建：`bot.py:2647` → `_build_model_quick_reply_keyboard(task_id=...)`
  - 仅当传入 `task_id` 可被规范化为 `TASK_XXXX` 时，才追加 **🧪 任务状态更新为测试中** 按钮（`MODEL_TASK_TO_TEST_PREFIX`）。
- 会话与任务绑定缓存：`bot.py:6155` → `SESSION_TASK_BINDINGS`
- 模型输出投递时注入键盘：`bot.py:6743` → `_deliver_pending_messages(...)`
  - `bound_task_id = SESSION_TASK_BINDINGS.get(session_key)`（`bot.py:6762`）
- 会话绑定写入时机（目前仅两处）：
  - 推送任务到模型成功后：`bot.py:1676` → `_push_task_to_model(...)` → `_bind_session_task(...)`（`bot.py:1745`）
  - 摘要请求成功后：`bot.py:10679` → `_request_task_summary(...)` → `_bind_session_task(...)`（`bot.py:10725`）

### 1.4 高置信度根因候选（至少两种）

#### 根因 A（高可能）：快捷回复触发新 session，但未继承 task 绑定
- “✅ 全部按推荐 / 🧩 部分按推荐”会再次调用 `_dispatch_prompt_to_model(...)`（`bot.py:8497`、`bot.py:8604`）。
- 这两条路径**没有**调用 `_bind_session_task(...)` 绑定新 `session_path` 到任务。
- 若模型侧每次执行会生成新的会话文件（pointer 切换），那么后续“模型答案消息”会因为 `bound_task_id=None` 而**缺少**“切到测试”按钮。

#### 根因 B（高可能）：模型输出过长走“附件模式”，用户只看到了无键盘的摘要消息
- `reply_large_text(...)` 在长文本时会：
  - 先发一条“摘要消息”（明确写了：**摘要消息不挂键盘**）：`bot.py:1091`~`bot.py:1104`
  - 再发一个文件（文件消息可挂键盘）：`bot.py:1105`~`bot.py:1113`
- 用户如果只关注摘要消息，就会感知“按钮消失”。

#### 根因 C（中等可能）：进程重启导致内存映射丢失
- `SESSION_TASK_BINDINGS` 是内存字典（`bot.py:6155`），若 bot 重启/热更新，旧会话输出到达时绑定已丢失，按钮不会出现。

### 1.5 修复方向（用户可选）
- 方案 A（最小改造）：在“快捷回复（全部/部分）”触发新 prompt 后，**把当前会话已绑定的 task_id 继承到新 session_key**，确保按钮持续可见。
- 方案 B（体验增强）：长文本的“摘要消息”也挂同一套 `reply_markup`，避免用户必须去找文件消息才能点按钮。
- 方案 C（增强鲁棒性）：把 session↔task 绑定做持久化（例如落库/写入 sidecar 文件），避免重启丢失。

### 1.6 验收标准（AC，可测试）
1. 对“已绑定任务”的模型输出消息，底部始终展示 **🧪 任务状态更新为测试中** 按钮。
2. 点击后任务状态变为 `test`，并收到确认提示；原模型消息不被编辑覆盖（`bot.py:8553`）。
3. 触发“✅ 全部按推荐 / 🧩 部分按推荐”后，下一条模型输出消息底部仍能看到该按钮（不因 session 切换而消失）。
4. 当模型输出过长走附件模式时，用户在摘要消息处也能看到该按钮（若采用方案 B）。

## 2) 参考资料（可验证来源）
- Telegram Bot API：InlineKeyboardMarkup  
  https://core.telegram.org/bots/api#inlinekeyboardmarkup
- Telegram Bot API：InlineKeyboardButton  
  https://core.telegram.org/bots/api#inlinekeyboardbutton
- Telegram Bot API：sendMessage（支持 `reply_markup`）  
  https://core.telegram.org/bots/api#sendmessage
- Telegram Bot API：sendDocument（支持 `reply_markup`）  
  https://core.telegram.org/bots/api#senddocument

